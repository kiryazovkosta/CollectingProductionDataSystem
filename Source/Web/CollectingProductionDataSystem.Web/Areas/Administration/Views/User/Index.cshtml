@model IEnumerable<CollectingProductionDataSystem.Web.Areas.Administration.ViewModels.EditUserViewModel>

@{
    Layout = "~/Areas/Administration/Views/Shared/_KendoAdminLayout.cshtml";
}

<div class="panel panel-primary">
    <div class="panel-heading">
        User Accounts
    </div>
    @Html.AntiForgeryToken()
    @(Html.Kendo()
          .Grid(Model)
          .Name("users")
          .Columns(
               columns =>
               {
                   columns.Bound(c => c.Id).Width(45);
                   columns.Bound(c => c.UserName);
                   columns.Bound(c => c.Email);
                   columns.Bound(c => c.FullName);
                   columns.Bound(c => c.Occupation);
                   columns.Command(c => { c.Edit(); c.Destroy(); }).Width(220);
               })
          .Editable(editable => editable.Mode(GridEditMode.PopUp).TemplateName("EditUserViewModel").Window(window => window.Scrollable(false)))
          .Pageable(pageable => pageable
                .Refresh(true)
                .PageSizes(new[] { 10, 20, 50, 100 })
                .ButtonCount(5))
          .Sortable()
          .Scrollable(scr => scr.Height(430))
          .Filterable()
          .DataSource(dataSource => dataSource
                .Ajax()
                .PageSize(20)
                .ServerOperation(true)
                .Read(read => read.Action("GetAllUsers", "Ajax", new { area = "Administration" }).Data("sendAntiForgery"))
                                .Events(events => events.Error("error_handler").RequestEnd("restyle_grid"))
                        .Model(model =>
                        {
                            model.Id(p => p.Id);
                            model.Field(p => p.Id).Editable(false);
                            model.Field(p => p.UserName);
                            model.Field(p => p.Email);
                        })
                        .Update(update => update.Action("Edit", "User", new { area = "Administration" }).Data("sendAntiForgery"))
                        .Destroy(update => update.Action("Delete", "User", new { area = "Administration" }).Data("sendAntiForgery"))
            )
    )
</div>
<div class="well well-sm">
    @Html.ActionLink("Create", "Create", null, new { @class = "btn btn-primary" })
</div>

@if (TempData["success"] != null)
{
    <div id="success-message" class="alert alert-success alert-dismissable">
        <button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
        @TempData["success"]
    </div>
}

@* //Error window for kendo grid error event handler *@
<div id="err-window" style="display:none">@Html.Partial("_KendoGridErrorWindow")</div>

@section scripts{
    <script src="~/Scripts/custom/sendAntiForgery.js"></script>
    <script>
        $(document).ready(function () {
            var successMessage = $('#success-message');
            if (successMessage != null) {
                successMessage.fadeOut(7000);
            }
        });

        function error_handler(e) {
            if (e.errors) {
                // prevent window from closing
                var grid = $("#users").data("kendoGrid");
                grid.one("dataBinding", function (e) {
                    e.preventDefault();
                });

                var message = "";
                $.each(e.errors, function (key, value) {
                    if ('errors' in value) {
                        $.each(value.errors, function () {
                            message += this + "\n";
                        });
                    }
                });

                message = $('pre').text(message);
                message.addClass('validation-summary-errors');
                var validationSummary = $('#validation-summary');
                validationSummary.html(message);
                validationSummary.removeClass();
                validationSummary.addClass('validation-summary-errors');
                validationSummary.attr("display", "block");
            }
        }
    </script>
}

@section styles{
    <style>
        .k-edit-buttons {
            max-width: 650px;
            width: 632px;
        }

        .k-edit-form-container {
            width: 95%;
            margin-left: auto;
            margin-right: auto;
        }

        div.k-window-content {
            width: 685px;
        }
    </style>
}

